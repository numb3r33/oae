---

title: Representation

keywords: fastai
sidebar: home_sidebar

summary: "How to represent a trained additive tree model?"
description: "How to represent a trained additive tree model?"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_Representation.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">draw_tree</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">s</span><span class="o">=</span><span class="n">export_graphviz</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">special_characters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">)</span>
    <span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">graphviz</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;Tree {&#39;</span><span class="p">,</span>
       <span class="sa">f</span><span class="s1">&#39;Tree </span><span class="se">{{</span><span class="s1"> size=</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1">; ratio=</span><span class="si">{</span><span class="n">ratio</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Xtr</span><span class="p">,</span> <span class="n">Xte</span><span class="p">,</span> <span class="n">ytr</span><span class="p">,</span> <span class="n">yte</span> <span class="o">=</span> <span class="n">get_example_dataset</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">clf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">SEED</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xtr</span><span class="p">,</span> <span class="n">ytr</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>RandomForestClassifier(max_depth=3, n_estimators=5, n_jobs=-1, random_state=41)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ATMSKLEARN" class="doc_header"><code>class</code> <code>ATMSKLEARN</code><a href="https://github.com/numb3r33/oae/tree/master/oae/tree.py#L21" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ATMSKLEARN</code>(<strong><code>trained_model</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="combine" class="doc_header"><code>combine</code><a href="https://github.com/numb3r33/oae/tree/master/oae/tree.py#L178" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>combine</code>(<strong><code>leaves_value</code></strong>, <strong><code>class_</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">atm</span> <span class="o">=</span> <span class="n">ATMSKLEARN</span><span class="p">(</span><span class="n">clf</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">atm</span><span class="o">.</span><span class="n">num_trees</span> <span class="o">==</span> <span class="mi">5</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">atm</span><span class="o">.</span><span class="n">calculate_tree_weights</span><span class="p">()</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">atm</span><span class="o">.</span><span class="n">get_leaves</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tree_</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="n">leaves_value</span><span class="p">,</span> <span class="n">class_</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">class_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">class_</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">c</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">/</span> <span class="n">c</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())[</span><span class="n">class_</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">leaves_value</span><span class="p">]</span>

<span class="k">assert</span> <span class="n">atm</span><span class="o">.</span><span class="n">h_k</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tree_</span><span class="p">,</span> <span class="n">combine</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.10526315789473684</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For each leaf node $k = 1,. . ., m_t$, we use a binary variable $\phi_{t,k}$ ∈ {0, 1} to denote whether a given instance x reaches it. Due to the property of the tree structure, each instance reaches exactly one leaf node.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
$$\sum_{k=1}^{m_t} \phi_{t,k} = 1  $$<p>for t = 1,...,T</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For a particular instance <code>Xte[4]</code> the following matrix represents in which leaf node would this instance reach. e.g:
for tree-0 this instance would reach 0th leaf, for tree-1 this instance would also reach 0th leaf and so on.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">atm</span><span class="o">.</span><span class="n">phi_t_k</span><span class="p">(</span><span class="n">Xte</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[[1, 0, 0, 0, 0, 0],
 [1, 0, 0, 0, 0, 0],
 [0, 0, 0, 0, 0, 1, 0, 0],
 [0, 1, 0, 0, 0],
 [0, 1, 0, 0, 0, 0]]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This test is to check whether an instance reaches exactly one leaf one in all trees or not.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">sum</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">atm</span><span class="o">.</span><span class="n">phi_t_k</span><span class="p">(</span><span class="n">Xte</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">])])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This way, $f_{t}(x)$ can be expressed as:
$f_{t}(x) = \sum_{k=1}^{m_t} h_{t,k}\phi_{t,k}$, where $h_{t_k} \in R$</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In case of classification, we look at the class distribution of leaves and report average as $h_{t,k}$ for k-th leaf node of t-th tree</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">atm</span><span class="o">.</span><span class="n">h_t_k</span><span class="p">(</span><span class="n">combine</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[[1.0, 0.4, 1.0, 1.0, 0.10526315789473684, 0.5],
 [1.0, 0.0, 0.8571428571428571, 1.0, 0.07317073170731707, 1.0],
 [0.0, 1.0, 0.0, 0.75, 0.75, 1.0, 1.0, 0.16666666666666666],
 [1.0, 0.8333333333333334, 1.0, 0.13953488372093023, 0.7142857142857143],
 [0.0, 0.9375, 1.0, 0.0, 0.16, 1.0]]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">h_t_k</span>   <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">h_t_k</span><span class="p">(</span><span class="n">combine</span><span class="p">)</span>
<span class="n">phi_t_k</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">phi_t_k</span><span class="p">(</span><span class="n">Xte</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span> 
<span class="n">w_t</span>     <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">calculate_tree_weights</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">Xte</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([[0.04583333, 0.95416667]])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The following test is to verify that $f_{t}(x) = \frac{1}{w_{t}} \sum_{k=1}^{m_t} h_{t,k}\phi_{t,k}$, where $h_{t_k} \in R$ is equal to <code>clf.predict_proba(x)[1]</code> or not, assuming <code>1</code> is the class of interest.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tolerance</span> <span class="o">=</span> <span class="mf">1e-6</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">h_t_k</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">phi_t_k</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">w_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h_t_k</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">h_t_k</span><span class="p">[</span><span class="n">i</span><span class="p">]))])</span>\
              <span class="o">-</span> <span class="mf">0.9541667</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Instance" class="doc_header"><code>class</code> <code>Instance</code><a href="https://github.com/numb3r33/oae/tree/master/oae/tree.py#L183" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Instance</code>(<strong><code>x</code></strong>, <strong><code>dtypes</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Given an additive tree model, each feature $x_i, i = 1,..., D$, is split into a
number of partitions.</p>
<ul>
<li>If $x_i$ is categorical with n categories, then xi naturally has n partitions.</li>
<li>If $x_i$ is numerical, we assume each tree node branches in the form of $x_i \geq b$ where $b \in R$ is a splitting point.</li>
</ul>
<p>If there are n splitting points for $x_i$ in all the trees in the additive tree model, the feature $x_i$ is naturally split into n + 1 partitions. In the following, let $n_i$ be the number of partitions for feature $x_i$.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Feature value variables. Given an instance x, we use a binary variable $v_{i,j} \in \{0, 1\}$ to denote whether $x_i$ is in the jth partition of dimension i. $v_{i,j} = 1$ if and only if $x_i$ is in the jth partition.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since an instance could only reside in exactly one partition for each feature, we know that $v_{i,j}$ should satisfy</p>
<p>{% raw %}
$$\sum_{j=1}^{n_i} v_{i,j} = 1$$
{% endraw %}</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">atm</span> <span class="o">=</span> <span class="n">ATMSKLEARN</span><span class="p">(</span><span class="n">clf</span><span class="p">)</span>

<span class="n">partitions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">1e8</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7815466523170471</span><span class="p">],</span>
             <span class="p">[</span><span class="o">-</span><span class="mf">1.7815466523170471</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.470717191696167</span><span class="p">],</span>
             <span class="p">[</span><span class="o">-</span><span class="mf">1.470717191696167</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0116309821605682</span><span class="p">],</span>
             <span class="p">[</span><span class="o">-</span><span class="mf">1.0116309821605682</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5423658043146133</span><span class="p">],</span>
             <span class="p">[</span><span class="o">-</span><span class="mf">0.5423658043146133</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.531291589140892</span><span class="p">],</span>
             <span class="p">[</span><span class="o">-</span><span class="mf">0.531291589140892</span><span class="p">,</span> <span class="mf">2.3792918920516968</span><span class="p">],</span>
             <span class="p">[</span><span class="mf">2.3792918920516968</span><span class="p">,</span> <span class="mf">1e8</span><span class="p">]])</span>

<span class="k">assert</span> <span class="nb">all</span><span class="p">((</span><span class="n">atm</span><span class="o">.</span><span class="n">v_j</span><span class="p">(</span><span class="n">fidx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;numerical&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">partitions</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">instance</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">Xte</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;numerical&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">instance</span><span class="o">.</span><span class="n">fnames</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;f_0&#39;, &#39;f_1&#39;, &#39;f_2&#39;, &#39;f_3&#39;, &#39;f_4&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">instance</span><span class="o">.</span><span class="n">dtypes</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;numerical&#39;, &#39;numerical&#39;, &#39;numerical&#39;, &#39;numerical&#39;, &#39;numerical&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>atm.v_i_j(instance)</code> lists down all the partitions based on feature type for a particular instance</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">atm</span><span class="o">.</span><span class="n">v_i_j</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[[[-100000000.0, -2.0248294472694397],
  [-2.0248294472694397, 0.6338021159172058],
  [0.6338021159172058, 0.6439935863018036],
  [0.6439935863018036, 0.6447310447692871],
  [0.6447310447692871, 0.836201936006546],
  [0.836201936006546, 0.8496142029762268],
  [0.8496142029762268, 100000000.0]],
 [[-100000000.0, -1.7815466523170471],
  [-1.7815466523170471, -1.470717191696167],
  [-1.470717191696167, -1.0116309821605682],
  [-1.0116309821605682, -0.5423658043146133],
  [-0.5423658043146133, -0.531291589140892],
  [-0.531291589140892, 2.3792918920516968],
  [2.3792918920516968, 100000000.0]],
 [[-100000000.0, -0.5003760457038879],
  [-0.5003760457038879, 0.10728693753480911],
  [0.10728693753480911, 0.2221900150179863],
  [0.2221900150179863, 0.2427385449409485],
  [0.2427385449409485, 0.3585205078125],
  [0.3585205078125, 0.6139787286520004],
  [0.6139787286520004, 0.6645539551973343],
  [0.6645539551973343, 100000000.0]],
 [[-100000000.0, -0.16905810683965683],
  [-0.16905810683965683, -0.1664411947131157],
  [-0.1664411947131157, -0.14978579431772232],
  [-0.14978579431772232, -0.14464405924081802],
  [-0.14464405924081802, 100000000.0]],
 [[-100000000.0, -1.0038151741027832],
  [-1.0038151741027832, -0.8827621340751648],
  [-0.8827621340751648, 0.6848085820674896],
  [0.6848085820674896, 100000000.0]]]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">atm</span> <span class="o">=</span> <span class="n">ATMSKLEARN</span><span class="p">(</span><span class="n">clf</span><span class="p">)</span>

<span class="n">partitions</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">v_i_j</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="n">v_i_j_mask</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">v_i_j_mask</span><span class="p">(</span><span class="n">partitions</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>

<span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v_i_j_mask</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Given a leaf node $k$ in tree $t$, suppose $\pi_{t,k}$ is the set of all its ancestor nodes in the tree.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">atm</span> <span class="o">=</span> <span class="n">ATMSKLEARN</span><span class="p">(</span><span class="n">clf</span><span class="p">)</span>

<span class="n">pi_t_k</span>  <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">pi_t_k</span><span class="p">()</span>

<span class="k">assert</span> <span class="n">pi_t_k</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)]</span>
<span class="k">assert</span> <span class="n">pi_t_k</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>atm.predicates_mask(tree, pi_t_k[t][k][p], partitions)</code> represents $s_{k,p}$, where</p>
<p>For any node $p \in \pi_{t,k}$, suppose $p$ branches on feature $i$, we define $S_{k,p}$ to be the set containing all predicates $v_{i,j}$ satisfying that $v_{i,j}$ = 1 leads to the branch towards leaf node $k$.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">atm</span> <span class="o">=</span> <span class="n">ATMSKLEARN</span><span class="p">(</span><span class="n">clf</span><span class="p">)</span>

<span class="n">h_t_k</span>   <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">h_t_k</span><span class="p">(</span><span class="n">combine</span><span class="p">)</span>
<span class="n">phi_t_k</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">phi_t_k</span><span class="p">(</span><span class="n">Xte</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span> 
<span class="n">w_t</span>     <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">calculate_tree_weights</span><span class="p">()</span>


<span class="n">instance</span>   <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">Xte</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;numerical&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">partitions</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">v_i_j</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="n">v_i_j_mask</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">v_i_j_mask</span><span class="p">(</span><span class="n">partitions</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>

<span class="n">pi_t_k</span>  <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">pi_t_k</span><span class="p">()</span>

<span class="n">atm</span><span class="o">.</span><span class="n">predicates_mask</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tree_</span><span class="p">,</span> <span class="n">pi_t_k</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">partitions</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[1, 1, 0, 0, 0, 0, 0]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">s_t_k_p</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">atm</span><span class="o">.</span><span class="n">predicates_mask</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">tree_</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">partitions</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">pi_t_k</span><span class="p">[</span><span class="n">tidx</span><span class="p">][</span><span class="n">kidx</span><span class="p">]]</span>\
           <span class="k">for</span> <span class="n">kidx</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atm</span><span class="o">.</span><span class="n">get_leaves</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">tree_</span><span class="p">))]</span> \
           <span class="k">for</span> <span class="n">tidx</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">estimators_</span><span class="p">)]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Making use of the tree structure, we have the following properties:</p>
<ul>
<li>If $\phi_{t,k} = 1$, meaning that the instance x lies in the leaf node k in tree t, then there is always one of the predicates $v_{i,j}$ in $S_{k,p}$ being 1 for any node $p \in \pi_{t,k}$.</li>
<li>If $\phi_{t,k} = 0$, then there exists at least one node p such that all the predicates in $S_{k,p}$ are 0.</li>
</ul>
<p>Combining above two, we get</p>
<p>{% raw %}
$$\phi_{t, k} \leq \frac {1}{\mid {\pi_{t,k}}\mid} \sum_{p \in \pi_{t,k}}\sum_{v \in s_{k,p}} v, \forall t,k$$
{% endraw %}</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">trees</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">get_trees</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trees</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atm</span><span class="o">.</span><span class="n">get_leaves</span><span class="p">(</span><span class="n">trees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tree_</span><span class="p">))):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nancestors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pi_t_k</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">predicate</span> <span class="ow">in</span> <span class="n">s_t_k_p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">predicate</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">phi_t_k</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">res</span> <span class="o">/</span> <span class="n">nancestors</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Decision Logic constraint violated&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Export">Export<a class="anchor-link" href="#Export"> </a></h2>
</div>
</div>
</div>
</div>
 

